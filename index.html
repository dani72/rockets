<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rockets!</title>
</head>
<body>
    <canvas id="game-canvas" width="1400" height="800" style="border:1px solid black;"></canvas>
    <script type="module">
        import init, { Game } from "./pkg/canvas_rust_game.js";

        async function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }        

        async function start() {
            try {
                await init();

                const playerControllers = {
                    gamepad_rocket1 : null,
                    index_rocket1 : null,
                    gamepad_rocket2 : null,
                    index_rocket2 : null,
                }

                const rocketThrustOn = await loadImage("./assets/rocket_thrust_on.png");
                const rocketThrustOff = await loadImage("./assets/rocket_thrust_off.png");
                const asteroid_small = await loadImage("./assets/asteroid_small.png");
                const asteroid_medium = await loadImage("./assets/asteroid_medium.png");
                const asteroid_big = await loadImage("./assets/asteroid_big.png");
                const explosion = await loadImage("./assets/explosion.png");
                const canvas = document.getElementById("game-canvas");
                const ctx = canvas.getContext("2d");

                const game = new Game( canvas.width, canvas.height, asteroid_small, asteroid_medium, asteroid_big, rocketThrustOn, rocketThrustOff, explosion, ctx);

                window.addEventListener("gamepadconnected", (e) => {
                    console.log("Gamepad connected:", e.gamepad);

                    if( e.gamepad.id.startsWith( "Nimbus (Vendor")) {
                        console.log("Controller ignored: " + e.gamepad.id);
                        return;
                    }

                    const gamepadIndex = e.gamepad.index;

                    if (playerControllers.gamepad_rocket1 === null) {
                        playerControllers.gamepad_rocket1 = gamepadIndex;
                        playerControllers.index_rocket1 = game.create_rocket();
                        console.log("Assigned to rocket1:", gamepadIndex, " - ", playerControllers.index_rocket1);
                    } 
                    else if (playerControllers.gamepad_rocket2 === null) {
                        playerControllers.gamepad_rocket2 = gamepadIndex;
                        playerControllers.index_rocket2 = game.create_rocket();
                        console.log("Assigned to rocket2:", gamepadIndex);
                    }
                });

                function updateRocket( gamepad, index) {
                    const rotate = gamepad.axes[0].toFixed(2);
                    const thrust = gamepad.buttons[7].value;
                    const fire = gamepad.buttons[0].pressed;
                    const shield = gamepad.buttons[1].pressed;

                    game.update_rocket( index, thrust, rotate, fire, shield);
                }

                function animationLoop() {
                    try {
                        game.animate_frame();

                        const gamepads = navigator.getGamepads();

                        if( playerControllers.gamepad_rocket1 !== null) {
                            updateRocket( gamepads[playerControllers.gamepad_rocket1], playerControllers.index_rocket1);
                        }
                        if( playerControllers.gamepad_rocket2 !== null) {
                            updateRocket( gamepads[playerControllers.gamepad_rocket2], playerControllers.index_rocket2);
                        }

                        requestAnimationFrame(animationLoop);
                    } 
                    catch (error) {
                        console.error("Error in animation loop:", error);
                    }
                }

                animationLoop();

                window.addEventListener("keydown", (e) => {
                    if (e.key === "r" || e.key === "R") {
                        game.reset();
                    }
                });
            } catch (error) {
                console.error("Failed to initialize:", error);
            }
        }

        start();
    </script>
</body>
</html>