<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rockets!</title>
</head>
<body>
    <canvas id="game-canvas" width="1400" height="800" style="border:1px solid black;"></canvas>
    <script type="module">
        import init, { Game } from "./pkg/canvas_rust_game.js";

        async function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }        

        async function start() {
            try {
                await init();

                window.addEventListener("gamepadconnected", (e) => {
                    console.log("Gamepad connected:", e.gamepad);

                });

                const rocketThrustOn = await loadImage("./assets/rocket_thrust_on.png");
                const rocketThrustOff = await loadImage("./assets/rocket_thrust_off.png");
                const asteroid = await loadImage("./assets/asteroid.png");
                const explosion = await loadImage("./assets/explosion.png");
                const canvas = document.getElementById("game-canvas");
                const ctx = canvas.getContext("2d");

                const game = new Game( canvas.width, canvas.height, asteroid, rocketThrustOn, rocketThrustOff, explosion, ctx);

                function animationLoop() {
                    try {
                        game.render();

                        const gamepads = navigator.getGamepads();
                        const gamepad = gamepads[1];

                        if( gamepad ) {
                            const rotate = gamepad.axes[0].toFixed(2);
                            const thrust = gamepad.axes[1].toFixed(2);
                            const fire = gamepad.buttons[0].pressed;

                            game.update_active_object( -thrust, rotate, fire);
                        }

                        requestAnimationFrame(animationLoop);
                    } catch (error) {
                        console.error("Error in animation loop:", error);
                    }
                }


                // Start the animation loop
                animationLoop();
            } catch (error) {
                console.error("Failed to initialize:", error);
            }
        }

        start();
    </script>
</body>
</html>